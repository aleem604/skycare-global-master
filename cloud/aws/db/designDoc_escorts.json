{
  "views": {
    "expiringCredentials": {
      "map": "function (doc) {\n  if (doc.skycare == 'Escort') {\n    \n    if (doc.passportExpiration !== undefined ||\n        doc.licenseExpiration !== undefined ||\n        doc.alsExpiration !== undefined) {\n          \n      var now = Date.now();\n      var ninetyDays = 90 * 24 * 60 * 60 * 1000;\n      var passportIsExpiring = false;\n      var passportIsExpired = false;\n      var licenseIsExpiring = false;\n      var licenseIsExpired = false;\n      var alsIsExpiring = false;\n      var alsIsExpired = false;\n      \n      if (doc.passportExpiration !== undefined) {\n        var passExpireDate = Date.parse(doc.passportExpiration);\n        passportIsExpiring = (passExpireDate < (now + ninetyDays));\n        passportIsExpired = (passExpireDate < now);\n      } else {\n        doc.passportExpiration = '';\n        passportIsExpiring = true;\n        passportIsExpired = true;\n      }\n      \n      if (doc.licenseExpiration !== undefined) {\n        var licExpireDate = Date.parse(doc.licenseExpiration);\n        licenseIsExpiring = (licExpireDate < (now + ninetyDays));\n        licenseIsExpired = (licExpireDate < now);\n      } else {\n        doc.licenseExpiration = '';\n        licenseIsExpiring = true;\n        licenseIsExpired = true;\n      }\n      \n      if (doc.alsExpiration !== undefined) {\n        var alsExpireDate = Date.parse(doc.alsExpiration);\n        alsIsExpiring = (alsExpireDate < (now + ninetyDays));\n        alsIsExpired = (alsExpireDate < now);\n      } else {\n        doc.alsExpiration = '';\n        alsIsExpired = true;\n        alsIsExpiring = true;\n      }\n\n      // \"passportExpiration\": \"2019-01-30T00:00:00.000Z\",\n      // \"licenseExpiration\": \"2019-01-27T00:00:00.000Z\",\n      // \"alsExpiration\": \"2019-01-28T00:00:00.000Z\"\n    \n      if ( passportIsExpiring || licenseIsExpiring || alsIsExpiring ) {\n        emit([doc.userID, 0], {\n            \"passportIsExpired\": passportIsExpired,\n            \"passportExpiration\": doc.passportExpiration,\n            \"licenseIsExpired\": licenseIsExpired,\n            \"licenseExpiration\": doc.licenseExpiration,\n            \"alsIsExpired\": alsIsExpired,\n            \"alsExpiration\": doc.alsExpiration\n        });\n      }\n    } else {\n      emit([doc.userID, 0], {\n          \"passportIsExpired\": true,\n          \"passportExpiration\": \"\",\n          \"licenseIsExpired\": true,\n          \"licenseExpiration\": \"\",\n          \"alsIsExpired\": true,\n          \"alsExpiration\": \"\"\n      });\n    }\n  }\n\n  if (doc.skycare == 'User') {\n    if (doc.role == 'escort') {\n      emit([doc.userID, 1], {\n          \"email\": doc.email\n      });\n    }\n  }\n}"
    }
  },
  "language": "javascript"
}